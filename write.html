<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ê¸€ì“°ê¸°</title>
<style>
  /* ===== ê¸°ë³¸ í…Œë§ˆ ===== */
  body {
    background: #0b0f14; color: #e6f0ff;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
    padding: 20px;
  }
  input, textarea, select {
    width: 100%;
    background: #0e1a26; color: #e6f0ff;
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 8px; padding: 10px; margin-bottom: 10px;
  }
  input:focus, textarea:focus, select:focus {
    outline: none; border-color: #00ffd5; box-shadow: 0 0 0 3px rgba(0,255,213,.15);
  }
  .primary {
    background: linear-gradient(180deg, rgba(0,255,213,.12), rgba(0,255,213,.05));
    color: #00ffd5; border: 1px solid #00ffd5;
    border-radius: 8px; padding: 10px 20px; cursor: pointer;
  }
  .primary:hover { box-shadow: 0 0 12px rgba(0,255,213,.4); }
  .ghost {
    background: transparent; color: #00ffd5;
    border: 1px solid rgba(0,255,213,.35);
    border-radius: 8px; padding: 10px 20px; cursor: pointer;
  }
  .ghost:hover { box-shadow: 0 0 10px rgba(0,255,213,.35); }
  .write-actions { display: flex; gap: 8px; margin-top: 8px; }

  /* ===== reply.htmlê³¼ ë™ì¼í•œ ìƒë‹¨ í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ===== */
  .write-topbar {
    position: sticky; top: 0; z-index: 10;
    display: flex; align-items: center;
    padding: 10px 14px;
    backdrop-filter: saturate(120%) blur(10px);
    background: rgba(8,12,18,.6);
    border-bottom: 1px solid rgba(255,255,255,.06);
    margin: -20px -20px 12px; /* í˜ì´ì§€ íŒ¨ë”© ì•ˆ ë³´ì´ê²Œ ìƒë‹¨ í’€í­ */
  }
  .back-btn {
    cursor: pointer; padding: 8px 12px; border-radius: 999px;
    border: 1px solid rgba(0,255,213,.35); background: transparent;
    color: #00ffd5; font-weight: 600;
  }
  .back-btn:hover { box-shadow: 0 0 10px rgba(0,255,213,.35); }
</style>
</head>
<body>
  <!-- â† í™ˆìœ¼ë¡œ (reply.htmlê³¼ ë™ì¼ UX: history.back ìš°ì„ ) -->
  <nav class="write-topbar">
    <button id="go-home" class="back-btn" type="button">â† í™ˆìœ¼ë¡œ</button>
  </nav>

  <h1 style="margin:12px 0 14px;">ê¸€ì“°ê¸°</h1>

  <!-- form ìœ ì§€, ë²„íŠ¼ì€ type="button"ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ -->
  <form id="write-form">
    <!-- ì œëª© / ë‚´ìš© -->
    <input id="title" name="title" type="text" placeholder="ì œëª©" required />
    <textarea id="content" name="content" placeholder="ë‚´ìš©" rows="10" required></textarea>

    <!-- íƒœê·¸ ì„ íƒ (ê³µì§€ ì œì™¸) -->
    <label for="tag">íƒœê·¸ ì„ íƒ:</label>
    <select id="tag" name="tag">
      <option value="ììœ ">ììœ </option>
      <option value="Q&A">Q&A</option>
      <option value="ì •ë³´">ì •ë³´</option>
      <option value="ê³ ë¯¼ìƒë‹´">ê³ ë¯¼ìƒë‹´</option>
    </select>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="write-actions">
      <button id="save-post" class="primary" type="button">ì €ì¥</button>
      <button id="save-post-anon" class="ghost" type="button">ìµëª… ì‘ì„±</button>
    </div>
  </form>

  <script type="module">
    /* =================== Firebase (CDN, index.htmlê³¼ ë™ì¼) =================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXAaq4Cl1zheSWD0xclxXX0wfn3VUhsVQ",
      authDomain: "grade1-community.firebaseapp.com",
      projectId: "grade1-community",
      storageBucket: "grade1-community.firebasestorage.app",
      messagingSenderId: "257458054391",
      appId: "1:257458054391:web:25743f245b34fc1ace5ff2",
      measurementId: "G-6ML40374DX"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    /* =================== ìš”ì†Œ ì°¸ì¡° =================== */
    const form      = document.getElementById('write-form');
    const $title    = document.getElementById('title');
    const $content  = document.getElementById('content');
    const $tag      = document.getElementById('tag');
    const $save     = document.getElementById('save-post');
    const $saveAnon = document.getElementById('save-post-anon');
    const goHomeBtn = document.getElementById('go-home');

    /* =================== í™ˆ ë²„íŠ¼ (reply.htmlê³¼ ë™ì¼) =================== */
    if (goHomeBtn){
      goHomeBtn.addEventListener('click', () => {
        if (document.referrer && new URL(document.referrer).origin === location.origin) {
          history.back(); return;
        }
        location.href = './'; // index.html
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') goHomeBtn.click();
      });
    }

    /* =================== ë¡œê·¸ì¸ ë³´ì¥ =================== */
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try { await signInWithPopup(auth, provider); }
        catch (e) {
          console.error('[AUTH ERROR]', e);
          alert('ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          location.href = './';
        }
      }
    });

    /* =================== ì…ë ¥ ê²€ì¦ ìœ í‹¸ =================== */
    function validateInputs() {
      const title = ($title.value || '').trim();
      const content = ($content.value || '').trim();
      const tag = ($tag.value || 'ììœ ').trim();
      if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return null;
      }
      return { title, content, tag };
    }

    /* =================== ì €ì¥ ê³µí†µ í•¨ìˆ˜ (ìµëª…/ì‹¤ëª…) =================== */
    async function savePost({ anonymous = false } = {}) {
      const user = auth.currentUser;
      if (!user) { alert('ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

      const v = validateInputs(); if (!v) return;

      // ì¤‘ë³µ í´ë¦­ ë°©ì§€
      $save.disabled = true; $saveAnon.disabled = true;

      try {
        await addDoc(collection(db, 'posts'), {
          title: v.title,
          content: v.content,
          preview: v.content.length > 60 ? v.content.slice(0, 60) + 'â€¦' : v.content,
          uid: anonymous ? 'anonymous' : user.uid,
          author: anonymous ? 'ìµëª…' : (user.displayName || 'ìµëª…'),
          tag: v.tag, // ğŸ”¹ íƒœê·¸ ì €ì¥
          createdAt: serverTimestamp()
        });
        alert('ì €ì¥ ì™„ë£Œ!');
        location.href = './'; // í™ˆìœ¼ë¡œ ì´ë™
      } catch (err) {
        console.error('[SAVE ERROR]', err);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (err.message || err.code || err));
      } finally {
        $save.disabled = false; $saveAnon.disabled = false;
      }
    }

    /* =================== ì´ë²¤íŠ¸ ë°”ì¸ë”© =================== */
    // ì—”í„°ë¡œ submití•´ë„ ì €ì¥ ë²„íŠ¼ê³¼ ë™ì¼ ë™ì‘(ìƒˆë¡œê³ ì¹¨ ë°©ì§€)
    form.addEventListener('submit', (e) => { e.preventDefault(); $save.click(); });
    // ì‹¤ëª… ì €ì¥
    $save.addEventListener('click', () => savePost({ anonymous: false }));
    // ìµëª… ì €ì¥
    $saveAnon.addEventListener('click', () => savePost({ anonymous: true }));
  </script>
</body>
</html>

